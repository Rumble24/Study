#『极致』的二进制重排 https://juejin.cn/post/7432913408574930971
# 🐻记录启动速度优化30%的过程 https://juejin.cn/post/6844904151483154445

https://www.lixkit.com/posts/29690/


AppOrderFiles

在冷启动分页加载二进制文件时，发现很多页中都有启动时需要用到的方法，那么即使页里面也存在启动时不需要的方法，但是由于内存是分页管理的，要加载就要整页加载。这样就导致了大量不需要在 pre-main 阶段执行的方法，也会被加载到内存中，增加了启动的耗时。

重排序其实很简单。xcode已经为我们提供了这个机制，它使用的链接器叫做 ld, ld有一个参数叫做Order File, 我们可以通过配置order文件，来使编译时生成的二进制的文件的Link Map种的符号顺序，按照我们指定的顺序排列生成。而且 libobjc 实际上也做了二进制重排 。


获取启动代码执行顺序
确定App在启动的时候，调用了哪些函数（使用了哪些符号），这里推荐一个工具AppOrderFiles(github.com/yulingtianx… )，使用Clang SanitizerCoverage，通过编译器插装的方式，获取到调用函数的符号顺序（当然我们也可以在Build Settings中修改Write Link Map File为YES编译后会生成一个Link Map符号表txt，进行分析，创建我们自己的order文件）在App启动后，到首屏VC的viewDidLoad方法内输出order file。

输出的文件在App沙盒，用模拟器运行更方便，得到文件app.order，这里面就是排好序的符号列表，根据App的执行顺序，如果项目比较大的话，会比较久.
把order文件放到工程目录，配置到Xcode里面Build Setting -> Order File -> $(PROJECT_DIR)/xxx.order

# App启动顺序
1. 加载解析 info.plist 文件
系统会加载并解析应用程序的 Info.plist 文件，该文件包含了应用程序的配置信息，如应用程序的图标、启动图、权限要求等。
2. 创建沙盒
在 iOS 8 及其之后的版本，每次启动应用程序时都会生成一个新的沙盒路径，用于存储应用程序的数据、设置文件等。这个沙盒是应用程序的私有存储空间。
3. 权限检查
根据 Info.plist 文件中配置的权限要求，系统会检查应用程序所申请的各种权限状态，如访问相机、定位、通知等权限。
4. 加载 Mach-O 文件并运行动态连接器（Dynamic Link Editor，简称 dyld）

dyld 寻找合适的 CPU 运行环境；
dyld 加载程序依赖的动态库（系统动态库和第三方动态库）和源代码文件（.h/.m）编译生成目标文件（.o），并对这些动态库进行连接；
加载所有方法。在这个阶段，初始化 Runtime 并完成 Objective-C 的内存布局，包括加载所有类、方法等；
加载 C 函数；
加载类扩展和 Category。在这个阶段，Runtime 会对所有类结构进行初始化，包括加载类的扩展和 category；
加载 C++ 静态函数和执行 Objective-C 类的 +load 方法；
最后，调用 main 函数，应用程序的主逻辑开始执行。


Mach-O（Mach Object）是 macOS 和 iOS 等苹果操作系统上使用的一种可执行文件格式，类似于 Windows 上的 PE（Portable Executable）文件格式。
在编译过程中，源代码经过编译器的处理生成目标文件（.o 文件），然后链接器将这些目标文件以及所需的动态库链接成最终的 Mach-O 可执行文件。这个过程通常包括符号解析、重定位、符号表生成等步骤，最终生成一个完整的可执行文件，供操作系统加载和执行。

